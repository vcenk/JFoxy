// components/resume/studio/ResumeCanvas.tsx
// Center: The Resume "Paper" with Focus Mode

'use client'

import React, { useEffect } from 'react'
import { useResume } from '@/contexts/ResumeContext'
import { RichTextDisplay } from '@/components/ui/RichTextDisplay'
import { isValidTiptapJSON, plainTextToJSON } from '@/lib/utils/richTextHelpers'
import { JSONContent } from '@tiptap/core'

export const ResumeCanvas = () => {
  const {
    resumeData,
    activeSection,
    setActiveSection,
    setInspectorTab,
    designerSettings,
    sectionOrder,
    sectionSettings,
    selectedJsonResumeTheme,
    setSelectedJsonResumeTheme,
    renderedThemeHtml,
    setRenderedThemeHtml,
    isThemeLoading,
    setIsThemeLoading,
  } = useResume()

  const ensureRichText = (content: any): JSONContent => {
    if (isValidTiptapJSON(content)) {
      return content
    }
    if (typeof content === 'string') {
      return plainTextToJSON(content)
    }
    return plainTextToJSON('')
  }

  const handleSectionClick = (section: string) => {
    setActiveSection(section as any)
    setInspectorTab('content')
  }

  const formatDate = (dateStr: string | undefined): string => {
    if (!dateStr) return ''
    const { dateFormat } = designerSettings
    const date = new Date(dateStr)
    if (isNaN(date.getTime()) || date.getFullYear() < 1900) {
      return dateStr
    }

    const year = date.getUTCFullYear()
    const month = date.getUTCMonth()

    if (dateFormat === 'Month Year') {
      const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(date)
      return `${monthName} ${year}`
    }
    
    const monthPadded = String(month + 1).padStart(2, '0')
    return `${monthPadded}/${year}`
  }

  const Divider = () => {
    const { dividerStyle, accentColor } = designerSettings
    switch (dividerStyle) {
      case 'line':
        return <hr className="my-4" style={{ borderColor: accentColor }} />
      case 'dots':
        return <div className="text-center my-3 text-gray-400 tracking-[0.4em]">...</div>
      default:
        return null
    }
  }

  const getSectionClassName = (sectionKey: string) => {
    const baseClasses = 'print-avoid-break cursor-pointer transition-all p-2 rounded-lg'
    if (activeSection === sectionKey) {
      return `${baseClasses} opacity-100 ring-2 ring-purple-500`
    }
    return `${baseClasses} opacity-90 hover:opacity-100`
  }

  // Dynamic Header Style Helper
  const getHeaderStyle = () => ({
    color: designerSettings.accentColor,
    fontSize: `${designerSettings.fontSizeHeadings}pt`,
    fontWeight: designerSettings.fontWeightHeadings,
    letterSpacing: `${designerSettings.letterSpacing}em`,
    textTransform: designerSettings.textTransform as any,
    fontStyle: designerSettings.fontStyleHeadings,
    textDecoration: designerSettings.textDecorationHeadings,
  })

  // Scroll to section on click
  React.useEffect(() => {
    const el = document.querySelector(`[data-resume-section="${activeSection}"]`)
    if (!el) return
    el.scrollIntoView({ behavior: 'smooth', block: 'start' })
  }, [activeSection])

  // --- JSON Resume Theme Rendering Logic ---
  useEffect(() => {
    const fetchThemedResume = async () => {
      if (selectedJsonResumeTheme && resumeData) {
        setIsThemeLoading(true);
        setRenderedThemeHtml(null); // Clear previous HTML

        try {
          const response = await fetch('/api/resume/render-theme', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ resumeData, themeName: selectedJsonResumeTheme }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error Details:', errorText);
            throw new Error(`API error: ${response.statusText} - ${errorText}`);
          }

          const html = await response.text();
          setRenderedThemeHtml(html);
        } catch (error: any) {
          console.error('Failed to render JSON Resume theme:', error);
          setRenderedThemeHtml(`
            <div style="padding: 20px; color: red; text-align: center; font-family: sans-serif;">
              <h3>Error loading theme: ${selectedJsonResumeTheme}</h3>
              <p>${error.message}</p>
              <pre style="text-align: left; background: #f3f4f6; padding: 10px; border-radius: 4px; overflow: auto;">
                ${JSON.stringify(error, null, 2)}
              </pre>
            </div>
          `);
        } finally {
          setIsThemeLoading(false);
        }
      } else if (!selectedJsonResumeTheme) {
        // If no theme is selected, clear the rendered HTML
        setRenderedThemeHtml(null);
      }
    };

    fetchThemedResume();
  }, [resumeData, selectedJsonResumeTheme, setIsThemeLoading, setRenderedThemeHtml]); // Dependencies

  if (selectedJsonResumeTheme) {
    return (
      <div className="flex-1 h-full overflow-y-auto p-8 flex items-start justify-center bg-gray-900/50 relative">
        {isThemeLoading && (
          <div className="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 text-white text-lg z-10">
            Loading {selectedJsonResumeTheme} theme...
          </div>
        )}
        {renderedThemeHtml && (
          <iframe
            title="JSON Resume Theme Preview"
            srcDoc={renderedThemeHtml}
            className="w-[8.5in] h-[11in] shadow-2xl bg-white border-none"
            style={{ minHeight: '11in', width: '8.5in' }} // Ensure iframe takes the right dimensions
          />
        )}
         {!isThemeLoading && !renderedThemeHtml && selectedJsonResumeTheme && (
           <div className="text-gray-400 text-lg">Failed to load theme.</div>
         )}
      </div>
    );
  }

  // --- Original JobFoxy Resume Rendering Logic ---
  // Reusable function to render a section
  const renderSection = (section: string) => {
    // Check visibility
    if (sectionSettings[section as any]?.visible === false) return null

    const getTitle = (defaultTitle: string) => sectionSettings[section as any]?.customTitle || defaultTitle
    
    // Helper for List Styles
    const getListClass = () => {
      const style = sectionSettings[section as any]?.listStyle || 'disc'
      return `list-${style} list-outside ml-5 space-y-1 text-gray-700`
    }

    // Helper for Layout
    const getLayoutContainerClass = () => {
      const layout = sectionSettings[section as any]?.layout || 'list'
      if (layout === 'grid') return 'grid grid-cols-2 gap-x-4 gap-y-2'
      if (layout === 'columns') return 'columns-2 gap-8'
      return 'space-y-2' 
    }

    switch (section) {
            case 'contact':
              return (
                <div
                  key="contact"
                  data-resume-section="contact"
                  onClick={() => handleSectionClick('contact')}
                  className={getSectionClassName('contact')}
                >
                  <h1 
                    className="text-gray-900 mb-2" 
                    style={{ 
                      fontSize: `${designerSettings.fontSizeName}pt`, 
                      fontWeight: designerSettings.fontWeightName 
                    }}
                  >
                    {resumeData.contact.name || 'Your Name'}
                  </h1>
                  <div className="text-sm text-gray-600 space-x-4">
                    {resumeData.contact.email && <span>{resumeData.contact.email}</span>}
                    {resumeData.contact.phone && <span> | {resumeData.contact.phone}</span>}
                    {resumeData.contact.location && <span> | {resumeData.contact.location}</span>}
                  </div>
                  {(resumeData.contact.linkedin ||
                    resumeData.contact.github ||
                    resumeData.contact.portfolio) && (
                    <div className="text-sm text-gray-600 mt-1 space-x-4">
                      {resumeData.contact.linkedin && <span>{resumeData.contact.linkedin}</span>}
                      {resumeData.contact.github && <span> | {resumeData.contact.github}</span>}
                      {resumeData.contact.portfolio && <span> | {resumeData.contact.portfolio}</span>}
                    </div>
                  )}
                </div>
              )
            case 'targetTitle':
              return (
                resumeData.targetTitle && (
                  <div
                    key="targetTitle"
                    data-resume-section="targetTitle"
                    onClick={() => handleSectionClick('targetTitle')}
                    className={getSectionClassName('targetTitle')}
                  >
                    <h2
                      className="text-center mb-2"
                      style={{
                        ...getHeaderStyle(),
                        textTransform: 'uppercase', // Target title usually stays uppercase or follows generic? Let's assume generic for now but force center
                        letterSpacing: '0.1em'
                      }}
                    >
                      {resumeData.targetTitle}
                    </h2>
                  </div>
                )
              )
            case 'summary':
              return (
                <div
                  key="summary"
                  data-resume-section="summary"
                  onClick={() => handleSectionClick('summary')}
                  className={getSectionClassName('summary')}
                >
                  <h2 className="mb-2" style={getHeaderStyle()}>
                    {getTitle('Professional Summary')}
                  </h2>
                  <div className="text-gray-700">
                    <RichTextDisplay 
                      key={JSON.stringify(resumeData.summary)}
                      content={ensureRichText(resumeData.summary)} 
                    />
                  </div>
                </div>
              )
            case 'experience':
              return (
                <div
                  key="experience"
                  data-resume-section="experience"
                  onClick={() => handleSectionClick('experience')}
                  className={getSectionClassName('experience')}
                >
                  <h2 className="mb-3" style={getHeaderStyle()}>
                    {getTitle('Experience')}
                  </h2>
                  {resumeData.experience && resumeData.experience.length > 0 && (
                    <div className="space-y-4">
                      {resumeData.experience.map((exp, idx) => (
                        <div key={idx} className="print-avoid-break">
                          <div className="flex justify-between items-start mb-1">
                            <div>
                              <h3 className={`text-gray-900 ${designerSettings.boldPosition ? 'font-bold' : 'font-normal'}`}>{exp.position}</h3>
                              <p className="text-sm text-gray-700">{exp.company}</p>
                            </div>
                            <div className="text-sm text-gray-600 text-right">
                              {formatDate(exp.startDate)} - {exp.current ? 'Present' : formatDate(exp.endDate)}
                            </div>
                          </div>
                          {exp.bullets && exp.bullets.length > 0 && (
                            <ul className={getListClass()}>
                              {exp.bullets.map((bullet, bidx) => (
                                <li key={bidx}>
                                  <RichTextDisplay 
                                    key={JSON.stringify(bullet)}
                                    content={ensureRichText(bullet)} 
                                  />
                                </li>
                              ))}
                            </ul>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )
            case 'education':
              return (
                <div
                  key="education"
                  data-resume-section="education"
                  onClick={() => handleSectionClick('education')}
                  className={getSectionClassName('education')}
                >
                  <h2 className="mb-3" style={getHeaderStyle()}>
                    {getTitle('Education')}
                  </h2>
                  {resumeData.education && resumeData.education.length > 0 && (
                    <div className="space-y-3">
                      {resumeData.education.map((edu, idx) => (
                        <div key={idx}>
                          <div className="flex justify-between items-start">
                            <div>
                              <h3 className={`text-gray-900 ${designerSettings.boldPosition ? 'font-bold' : 'font-normal'}`}>{edu.institution}</h3>
                              <p className="text-sm text-gray-700">
                                {edu.degree} {edu.field && `in ${edu.field}`}
                              </p>
                            </div>
                            <div className="text-sm text-gray-600">
                              {formatDate(edu.graduationDate)}
                              {edu.gpa && ` | GPA: ${edu.gpa}`}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )
            case 'skills':
              return (
                <div
                  key="skills"
                  data-resume-section="skills"
                  onClick={() => handleSectionClick('skills')}
                  className={getSectionClassName('skills')}
                >
                  <h2 className="mb-3" style={getHeaderStyle()}>
                    {getTitle('Skills')}
                  </h2>
                  {(resumeData.skills.technical?.length ||
                    resumeData.skills.tools?.length ||
                    resumeData.skills.languages?.length) && (
                    <div className={`${getLayoutContainerClass()} text-sm`}>
                      {resumeData.skills.technical && resumeData.skills.technical.length > 0 && (
                        <div>
                          <span className="font-semibold text-gray-900">Technical: </span>
                          <span className="text-gray-700">{resumeData.skills.technical.join(', ')}</span>
                        </div>
                      )}
                      {resumeData.skills.tools && resumeData.skills.tools.length > 0 && (
                        <div>
                          <span className="font-semibold text-gray-900">Tools: </span>
                          <span className="text-gray-700">{resumeData.skills.tools.join(', ')}</span>
                        </div>
                      )}
                      {/* Backward compatibility for languages if not in top-level */}
                      {!resumeData.languages && resumeData.skills.languages && resumeData.skills.languages.length > 0 && (
                        <div>
                          <span className="font-semibold text-gray-900">Languages: </span>
                          <span className="text-gray-700">{resumeData.skills.languages.join(', ')}</span>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )

            case 'projects':
              return (
                resumeData.projects && resumeData.projects.length > 0 && (
                  <div
                    key="projects"
                    data-resume-section="projects"
                    onClick={() => handleSectionClick('projects')}
                    className={getSectionClassName('projects')}
                  >
                    <h2 className="mb-3" style={getHeaderStyle()}>
                      {getTitle('Projects')}
                    </h2>
                    <div className="space-y-4">
                      {resumeData.projects.map((project, idx) => (
                        <div key={idx}>
                          <div className="flex justify-between items-start mb-1">
                            <div>
                              <h3 className={`text-gray-900 ${designerSettings.boldPosition ? 'font-bold' : 'font-normal'}`}>
                                {project.name}
                              </h3>
                              {project.link && (
                                <a href={project.link} target="_blank" rel="noreferrer" className="text-sm text-blue-600 hover:underline">
                                  {project.link.replace(/^https?:\/\//, '')}
                                </a>
                              )}
                            </div>
                          </div>
                          <div className="text-gray-700 mb-1">
                            <RichTextDisplay 
                              key={JSON.stringify(project.description)}
                              content={ensureRichText(project.description)} 
                            />
                          </div>
                          {project.technologies && project.technologies.length > 0 && (
                            <p className="text-sm text-gray-600">
                              <span className="font-medium">Tech:</span> {project.technologies.join(', ')}
                            </p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )
              )

            case 'certifications':
              const certs = resumeData.certifications || 
                (resumeData.skills.certifications?.map(c => ({ name: c })) || [])

              return (
                certs.length > 0 && (
                  <div
                    key="certifications"
                    data-resume-section="certifications"
                    onClick={() => handleSectionClick('certifications')}
                    className={getSectionClassName('certifications')}
                  >
                    <h2 className="mb-3" style={getHeaderStyle()}>
                      {getTitle('Certifications')}
                    </h2>
                    <ul className={getListClass()}>
                      {certs.map((cert, idx) => (
                        <li key={idx}>
                          <span className="font-medium text-gray-900">{cert.name}</span>
                          {cert.issuer && <span className="text-gray-600"> - {cert.issuer}</span>}
                          {cert.date && <span className="text-gray-500 text-sm"> ({cert.date})</span>}
                        </li>
                      ))}
                    </ul>
                  </div>
                )
              )

            case 'awards':
              return (
                resumeData.awards && resumeData.awards.length > 0 && (
                  <div
                    key="awards"
                    data-resume-section="awards"
                    onClick={() => handleSectionClick('awards')}
                    className={getSectionClassName('awards')}
                  >
                    <h2 className="mb-3" style={getHeaderStyle()}>
                      {getTitle('Awards')}
                    </h2>
                    <div className="space-y-2">
                      {resumeData.awards.map((award, idx) => (
                        <div key={idx}>
                          <div className="flex justify-between items-baseline">
                            <h3 className="font-medium text-gray-900">{award.title}</h3>
                            <span className="text-sm text-gray-600">{award.date}</span>
                          </div>
                          {(award.issuer || award.description) && (
                            <p className="text-sm text-gray-700">
                              {award.issuer && <span className="font-medium">{award.issuer}</span>}
                              {award.issuer && award.description && ' - '}
                              {award.description}
                            </p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )
              )

            case 'volunteer':
              return (
                resumeData.volunteer && resumeData.volunteer.length > 0 && (
                  <div
                    key="volunteer"
                    data-resume-section="volunteer"
                    onClick={() => handleSectionClick('volunteer')}
                    className={getSectionClassName('volunteer')}
                  >
                    <h2 className="mb-3" style={getHeaderStyle()}>
                      {getTitle('Volunteer Experience')}
                    </h2>
                    <div className="space-y-3">
                      {resumeData.volunteer.map((vol, idx) => (
                        <div key={idx}>
                          <div className="flex justify-between items-start">
                            <div>
                              <h3 className={`text-gray-900 ${designerSettings.boldPosition ? 'font-bold' : 'font-normal'}`}>
                                {vol.role}
                              </h3>
                              <p className="text-sm text-gray-700">{vol.organization}</p>
                            </div>
                            <div className="text-sm text-gray-600">
                              {formatDate(vol.startDate)} - {vol.current ? 'Present' : formatDate(vol.endDate)}
                            </div>
                          </div>
                          {vol.description && (
                            <div className="mt-1 text-gray-700">
                               <RichTextDisplay 
                                 key={JSON.stringify(vol.description)}
                                 content={ensureRichText(vol.description)} 
                               />
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )
              )

            case 'publications':
              return (
                resumeData.publications && resumeData.publications.length > 0 && (
                  <div
                    key="publications"
                    data-resume-section="publications"
                    onClick={() => handleSectionClick('publications')}
                    className={getSectionClassName('publications')}
                  >
                    <h2 className="mb-3" style={getHeaderStyle()}>
                      {getTitle('Publications')}
                    </h2>
                    <ul className={getListClass()}>
                      {resumeData.publications.map((pub, idx) => (
                        <li key={idx}>
                          <span className="font-medium text-gray-900">{pub.title}</span>
                          {pub.publisher && <span>, {pub.publisher}</span>}
                          {pub.date && <span className="text-gray-500 text-sm"> ({pub.date})</span>}
                          {pub.link && (
                             <a href={pub.link} target="_blank" rel="noreferrer" className="ml-2 text-xs text-blue-600 hover:underline">
                               Link
                             </a>
                          )}
                        </li>
                      ))}
                    </ul>
                  </div>
                )
              )

            case 'languages':
               const languages = resumeData.languages || 
                 (resumeData.skills.languages?.map(l => ({ language: l })) || [])

               return (
                 languages.length > 0 && (
                   <div
                     key="languages"
                     data-resume-section="languages"
                     onClick={() => handleSectionClick('languages')}
                     className={getSectionClassName('languages')}
                   >
                     <h2 className="mb-3" style={getHeaderStyle()}>
                       {getTitle('Languages')}
                     </h2>
                     <div className={`${getLayoutContainerClass()} text-gray-700`}>
                       {languages.map((lang, idx) => (
                         <div key={idx} className="flex justify-between">
                           <span className="font-medium">{lang.language}</span>
                           {lang.fluency && <span className="text-gray-500 text-sm">{lang.fluency}</span>}
                         </div>
                       ))}
                     </div>
                   </div>
                 )
               )

            default:
              return null
          }
        }
      
        // --- LAYOUT LOGIC ---
        const headerSections = ['contact', 'targetTitle']
        const sidebarSections = [
          'education',
          'skills',
          'projects',
          'certifications',
          'awards',
          'volunteer',
          'publications',
          'languages',
        ]
      
        const allSections = sectionOrder.map(sectionId => renderSection(sectionId)).filter(Boolean)
      
        const headerContent = allSections.filter(comp => headerSections.includes(comp.key))
        const mainColContent: JSX.Element[] = []
        const sideColContent: JSX.Element[] = []
      
        if (designerSettings.columns === 2) {
          allSections.forEach(comp => {
            if (headerSections.includes(comp.key)) return // Handled separately
            if (sidebarSections.includes(comp.key)) {
              sideColContent.push(comp)
            } else {
              mainColContent.push(comp)
            }
          })
        }
      
        const PageNumberStyles = () => {
          const { enabled, alignment } = designerSettings.pageNumbers
          
          const pageNumberCss = enabled ? `
            @page {
              margin-bottom: 0.75in;
            }
            @page :first {
              margin-bottom: 0.5in;
            }
            @page {
              @bottom-${alignment} {
                content: "Page " counter(page);
                font-size: 10pt;
                color: #888;
              }
            }
          ` : ''
      
          const css = `
            @media print {
              .print-avoid-break {
                break-inside: avoid;
              }
              ${pageNumberCss}
            }
          `
          return <style>{css}</style>
        }
        const PAGE_DIMENSIONS = {
          letter: { width: '8.5in', height: '11in', heightPx: 1056 }, // 96 DPI
          a4: { width: '210mm', height: '297mm', heightPx: 1123 },
        }
      
        const currentDim = PAGE_DIMENSIONS[designerSettings.paperSize]
  return (
    <div className="flex-1 h-full overflow-y-auto p-8 flex items-start justify-center bg-gray-900/50">
      <PageNumberStyles />
      {/* The Paper */}
      <div
        className="bg-white shadow-2xl transition-all duration-300 ease-in-out relative"
        style={{
          width: currentDim.width,
          minHeight: currentDim.height,
          padding: `${designerSettings.margins}px`,
          fontFamily:
            designerSettings.fontFamily === 'inter' ? 'var(--font-inter), sans-serif' : 
            '-apple-system, BlinkMacSystemFont, sans-serif',
          lineHeight: designerSettings.lineHeight,
          fontSize: `${designerSettings.fontSizeBody}pt`,
          // Visual Page Breaks (Simulated Gap)
          backgroundImage: `linear-gradient(to bottom, white 0%, white calc(100% - 10px), #e5e7eb calc(100% - 10px), #e5e7eb 100%)`,
          backgroundSize: `100% ${currentDim.heightPx}px`,
          backgroundRepeat: 'repeat-y',
        }}
      >
        {/* Print-specific overrides to hide the background lines */}
        <style jsx>{`
          @media print {
            .bg-white {
              background-image: none !important;
              box-shadow: none !important;
              width: 100% !important;
              height: auto !important;
              margin: 0 !important;
              padding: 0 !important;
            }
          }
        `}</style>

        {/* Render header */}
        {headerContent.map((comp, index) => (
          <React.Fragment key={comp.key}>
            {comp}
            {index < headerContent.length - 1 && <Divider />}
          </React.Fragment>
        ))}
        
        {headerContent.length > 0 && <Divider />}

        {/* Render columns */}
        {designerSettings.columns === 2 ? (
          <div className="flex space-x-8">
            <div className="w-2/3">
              {mainColContent.map((comp, index) => (
                <React.Fragment key={comp.key}>
                  {comp}
                  {index < mainColContent.length - 1 && <Divider />}
                </React.Fragment>
              ))}
            </div>
            <div className="w-1/3">
              {sideColContent.map((comp, index) => (
                <React.Fragment key={comp.key}>
                  {comp}
                  {index < sideColContent.length - 1 && <Divider />}
                </React.Fragment>
              ))}
            </div>
          </div>
        ) : (
          <div>
            {allSections.filter(comp => !headerSections.includes(comp.key)).map((comp, index, arr) => (
              <React.Fragment key={comp.key}>
                {comp}
                {index < arr.length - 1 && <Divider />}
              </React.Fragment>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}